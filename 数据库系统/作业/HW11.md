### **15.2** 

> Consider the bank database of Figure 15.14, where the primary keys are underlined, and the 
> following SQL query: 
>
>  ```sql 
>  SELECT T.branch_name
>  FROM branch T, branch S
>  WHERE T.assets > S.assets AND S.branch_city = "Brooklyn"
>  ```
> 
>  Write an efficient relational-algebra expression that is equivalent to this query. 
>  Justify your choice. 
> 
>  <img src="C:/Users/HP/Desktop/数据库/作业/database_system_concepts_answers-main/Ch15_Query_Processing/figure15.14.png" style="zoom:50%;" >

尽可能少的数据执行 theta 连接。 先筛选出布鲁克林的 branch然后再连接，消除不需要的属性

$$
\Pi_{T.branch\_name} ( (\Pi_{branch\_name, assets}(\rho_T(branch))) \bowtie_{T.assets > S.assets}  (\Pi_{assets} (\sigma_{branch\_city = 'Brooklyn'}(\rho_S(branch)))))
$$



### 15.3

> Let relations $r_1(A, B, C)$ and $r_2(C, D, E)$ have the following properties: $r_1$ has $20,000$ tuples, $r_2$ has $45,000$ tuples, $25$ tuples of $r_1$ fit on one block, and $30$ tuples of $r_2$ fit on one block. Estimate the number of block transfers and seeks required using each of the following join strategies for $r_1 \bowtie r_2$: 
>
> a. Nested-loop join. 
>
> b. Block nested-loop join. 
>
> c. Merge join. 
>
> d. Hash join. 

#### a Nested-loop join.  嵌套循环连接

如果$r_1$是外部关系，需要$ nr * bs + br =20000*1500+800=30,000,800$次磁盘访问和 $ nr+ br=20000 + 800 = 20,800$ 次磁盘搜索

如果$r_2$是外部关系，需要$ nr * bs + br =45000 * 800 + 1500 = 36,001,500$次磁盘访问和 $ nr+ br= 45000 + 1500 = 46,500$ 次磁盘搜索

#### b Block nested-loop join.

如果$r_1$是外部关系，需要$\lceil \frac{800}{M-2} \rceil * 1500 + 800$次磁盘访问和$2 * \lceil \frac{800}{M-2} \rceil$ 次磁盘搜索

如果$r_2$是外部关系，需要$\lceil \frac{1500}{M-2} \rceil * 800 + 1500$ 次磁盘访问 和$2 * \lceil frac{1500}{M-2} \rceil$次 磁盘搜索

#### c Merge join. 

排序后, 块传输$br+bs$次 .  磁盘搜索$ \lceil br/bb\rceil + \lceil bs/bb \rceil$次

假设$r_1$和$r_2$最初没有按连接键排序，且$b_b=1$，总排序成本为$B_s = 1500(2 \lceil \log_{M - 1} (1500/M) \rceil + 2) + 800(2 \lceil \log_{M - 1} (800/M) \rceil + 2)$次磁盘访问。假设所有具有相同的连接属性值的图元都适合在内存中、 总成本是 $B_s + 1500 + 800$ 次磁盘访问

#### d Hash join.

我们假设没有溢出发生。由于$r_1$较小，我们用它作为建立关系，$r_2$作为探测关系

如果$M>800/M$，即**不需要递归**，那么成本是 $3(br + bs) =3 (1500 + 800) = 6900$ 次磁盘访问

**需要递归**时，成本为 $2 (1500 + 800) \log_{M-1}(800) - 1 \rceil + 1500 + 800$次磁盘访问
